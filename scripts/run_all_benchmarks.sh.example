#!/usr/bin/env bash
#
# Run ALL benchmarks across ALL providers simultaneously
# Uses isolated kubeconfigs per-subshell to avoid context conflicts
#
# Setup:
#   cp scripts/run_all_benchmarks.sh.example scripts/run_all_benchmarks.sh
#   # Edit run_all_benchmarks.sh with your actual endpoints and kubeconfig paths
#   chmod +x scripts/run_all_benchmarks.sh
#
# Usage: ./scripts/run_all_benchmarks.sh
#

set -euo pipefail

# ============================================================
# CONFIGURATION â€” Replace these with your actual values
# ============================================================

# Frontend endpoints (from: kubectl get svc -n rag-app rag-app-rag-app-frontend)
LKE_FRONTEND_URL="http://<LKE-FRONTEND-IP>/api/query/stream"
EKS_FRONTEND_URL="http://<EKS-ELB-HOSTNAME>.us-east-1.elb.amazonaws.com/api/query/stream"
GKE_FRONTEND_URL="http://<GKE-FRONTEND-IP>/api/query/stream"

# Kubeconfig paths
LKE_KUBECONFIG_FILE="$HOME/.kube/<lke-kubeconfig>.yaml"
# EKS and GKE may share a kubeconfig file with separate contexts
EKS_GKE_KUBECONFIG_FILE="$HOME/.kube/<eks-kubeconfig>.yaml"
EKS_CONTEXT="arn:aws:eks:<REGION>:<ACCOUNT-ID>:cluster/<CLUSTER-NAME>"
GKE_CONTEXT="gke_<PROJECT-ID>_<ZONE>_<CLUSTER-NAME>"

# ============================================================

echo "========================================="
echo "=== Starting ALL benchmarks across ALL providers ==="
echo "========================================="
echo ""
echo "Running North-South (500 req, 50 concurrency) + East-West simultaneously..."
echo ""

PIDS=()
TEMP_FILES=()

cleanup() {
  for f in "${TEMP_FILES[@]}"; do
    rm -f "$f" 2>/dev/null || true
  done
}
trap cleanup EXIT

# Create isolated kubeconfig copies for EKS and GKE (they share a file)
EKS_KUBECONFIG=$(mktemp /tmp/eks-kubeconfig-XXXXXX.yaml)
GKE_KUBECONFIG=$(mktemp /tmp/gke-kubeconfig-XXXXXX.yaml)
TEMP_FILES+=("$EKS_KUBECONFIG" "$GKE_KUBECONFIG")

cp "$EKS_GKE_KUBECONFIG_FILE" "$EKS_KUBECONFIG"
cp "$EKS_GKE_KUBECONFIG_FILE" "$GKE_KUBECONFIG"

KUBECONFIG="$EKS_KUBECONFIG" kubectl config use-context "$EKS_CONTEXT" >/dev/null 2>&1
KUBECONFIG="$GKE_KUBECONFIG" kubectl config use-context "$GKE_CONTEXT" >/dev/null 2>&1

# ============================================================
# NORTH-SOUTH BENCHMARKS (external API endpoint tests)
# ============================================================

# NS - Akamai LKE
(
  echo "[NS-LKE] Starting North-South benchmark..."
  ./scripts/benchmark/run_ns.sh akamai-lke \
    --url "$LKE_FRONTEND_URL" \
    --requests 500 --concurrency 50 --warmup 20 --max-output-tokens 256
  echo "[NS-LKE] Done!"
) &
PIDS+=($!)

# NS - AWS EKS
(
  echo "[NS-EKS] Starting North-South benchmark..."
  ./scripts/benchmark/run_ns.sh aws-eks \
    --url "$EKS_FRONTEND_URL" \
    --requests 500 --concurrency 50 --warmup 20 --max-output-tokens 256
  echo "[NS-EKS] Done!"
) &
PIDS+=($!)

# NS - GCP GKE
(
  echo "[NS-GKE] Starting North-South benchmark..."
  ./scripts/benchmark/run_ns.sh gcp-gke \
    --url "$GKE_FRONTEND_URL" \
    --requests 500 --concurrency 50 --warmup 20 --max-output-tokens 256
  echo "[NS-GKE] Done!"
) &
PIDS+=($!)

# ============================================================
# EAST-WEST BENCHMARKS (in-cluster network tests)
# Each uses an isolated KUBECONFIG copy to avoid conflicts
# ============================================================

# EW - Akamai LKE
(
  echo "[EW-LKE] Starting East-West benchmark..."
  export KUBECONFIG="$LKE_KUBECONFIG_FILE"
  ./scripts/netprobe/run_ew.sh \
    --provider akamai-lke \
    --kubeconfig "$LKE_KUBECONFIG_FILE"
  echo "[EW-LKE] Done!"
) &
PIDS+=($!)

# EW - AWS EKS (isolated copy with EKS context pre-selected)
(
  echo "[EW-EKS] Starting East-West benchmark..."
  export KUBECONFIG="$EKS_KUBECONFIG"
  ./scripts/netprobe/run_ew.sh \
    --provider aws-eks \
    --kubeconfig "$EKS_KUBECONFIG"
  echo "[EW-EKS] Done!"
) &
PIDS+=($!)

# EW - GCP GKE (isolated copy with GKE context pre-selected)
(
  echo "[EW-GKE] Starting East-West benchmark..."
  export KUBECONFIG="$GKE_KUBECONFIG"
  export USE_GKE_GCLOUD_AUTH_PLUGIN=True
  ./scripts/netprobe/run_ew.sh \
    --provider gcp-gke \
    --kubeconfig "$GKE_KUBECONFIG"
  echo "[EW-GKE] Done!"
) &
PIDS+=($!)

# ============================================================
# WAIT FOR ALL BENCHMARKS
# ============================================================

echo ""
echo "All 6 benchmarks started. Waiting for completion..."
echo "PIDs: ${PIDS[*]}"
echo ""

FAILED=0
for PID in "${PIDS[@]}"; do
  if ! wait "$PID"; then
    echo "Process $PID failed"
    FAILED=$((FAILED + 1))
  fi
done

echo ""
echo "========================================="
if [[ $FAILED -eq 0 ]]; then
  echo "=== ALL BENCHMARKS COMPLETE ==="
else
  echo "=== BENCHMARKS COMPLETE ($FAILED failed) ==="
fi
echo "========================================="
echo ""

echo "Latest benchmark results:"
echo ""
echo "North-South (NS):"
ls -lt benchmarks/ns/*/2026*.json 2>/dev/null | head -6 || echo "  No NS results found"
echo ""
echo "East-West (EW):"
ls -lt benchmarks/ew/*/2026*.json 2>/dev/null | head -6 || echo "  No EW results found"

exit $FAILED
