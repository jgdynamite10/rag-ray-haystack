{{- if .Values.kuberay.enabled }}
apiVersion: ray.io/v1
kind: RayService
metadata:
  name: {{ include "rag-app.fullname" . }}-rayservice
  namespace: {{ .Values.global.namespace }}
spec:
  serviceUnhealthySecondThreshold: 300
  deploymentUnhealthySecondThreshold: 300
  serveConfigV2: |
    applications:
      - name: rag-backend
        import_path: app.main:deployment
        route_prefix: /
  rayClusterConfig:
    rayVersion: {{ .Values.kuberay.rayVersion | quote }}
    headGroupSpec:
      rayStartParams:
        dashboard-host: "0.0.0.0"
      template:
        spec:
          {{- with .Values.global.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumes:
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: {{ .Values.global.sharedMemorySize | quote }}
          containers:
            - name: ray-head
              image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
              imagePullPolicy: IfNotPresent
              volumeMounts:
                - name: dshm
                  mountPath: /dev/shm
              resources:
                requests:
                  cpu: {{ .Values.kuberay.head.cpu | quote }}
                  memory: {{ .Values.kuberay.head.memory | quote }}
                limits:
                  cpu: {{ .Values.kuberay.head.cpu | quote }}
                  memory: {{ .Values.kuberay.head.memory | quote }}
              livenessProbe:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 30
                periodSeconds: 10
                failureThreshold: 12
              readinessProbe:
                tcpSocket:
                  port: 6379
                initialDelaySeconds: 30
                periodSeconds: 10
                failureThreshold: 6
    workerGroupSpecs:
      - groupName: workers
        replicas: {{ .Values.kuberay.worker.replicas }}
        rayStartParams: {}
        template:
          spec:
            {{- with .Values.kuberay.worker.tolerations }}
            tolerations:
              {{- toYaml . | nindent 14 }}
            {{- end }}
            {{- with .Values.global.imagePullSecrets }}
            imagePullSecrets:
              {{- toYaml . | nindent 14 }}
            {{- end }}
            volumes:
              - name: dshm
                emptyDir:
                  medium: Memory
                  sizeLimit: {{ .Values.global.sharedMemorySize | quote }}
            containers:
              - name: ray-worker
                image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
                imagePullPolicy: IfNotPresent
                volumeMounts:
                  - name: dshm
                    mountPath: /dev/shm
                resources:
                  requests:
                    cpu: {{ .Values.kuberay.worker.cpu | quote }}
                    memory: {{ .Values.kuberay.worker.memory | quote }}
                  limits:
                    cpu: {{ .Values.kuberay.worker.cpu | quote }}
                    memory: {{ .Values.kuberay.worker.memory | quote }}
                livenessProbe:
                  exec:
                    command: ["python3", "-c", "import ray; ray.init(address='auto', ignore_reinit_error=True); assert ray.is_initialized()"]
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  failureThreshold: 6
                  timeoutSeconds: 10
                readinessProbe:
                  exec:
                    command: ["python3", "-c", "import ray; ray.init(address='auto', ignore_reinit_error=True); assert ray.is_initialized()"]
                  initialDelaySeconds: 60
                  periodSeconds: 15
                  failureThreshold: 6
                  timeoutSeconds: 10
{{- end }}
